---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlogCard from '../components/BlogCard.astro';
import ProjectCard from '../components/ProjectCard.astro';
import ShaderGradientEmbed from '../components/ShaderGradientEmbed.jsx';
import sampleBg from '../assets/sample.bg.png';
import selfPortrait from '../assets/self_v2.png';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
const projects = (await getCollection('projects')).sort((a, b) => {
  const aDate = a.data.pubDate?.valueOf() ?? 0;
  const bDate = b.data.pubDate?.valueOf() ?? 0;
  return bDate - aDate;
});
const latest = posts.slice(0, 3);
const heroWords = [
  { label: 'Designer', variant: 'hero-word-designer' },
  { label: 'Developer', variant: 'hero-word-developer' },
  { label: 'Builder', variant: 'hero-word-builder' },
  { label: 'Storyteller', variant: 'hero-word-storyteller' },
  { label: 'Alfonso', isName: true },
];
---
<BaseLayout title="Home" description="Personal site and blog for Alfonso Garibay.">
  <section class="grid gap-10">
    <div class="relative min-h-[460px] w-full overflow-hidden rounded-2xl border border-ink/10 bg-white/60">
      <div class="absolute inset-0">
        <ShaderGradientEmbed client:visible />
      </div>
      <div class="absolute inset-0 bg-paper/20"></div>
      <div class="relative z-10 flex h-full items-end p-6 sm:p-10">
        <div class="grid gap-6">
          <p class="text-xs uppercase tracking-[0.4em] text-ink/70">I build thoughtful digital things.</p>
          <h1 class="text-4xl font-semibold leading-tight text-ink sm:text-5xl">
            Hi, I&apos;m <span id="hero-cycle-prefix" class="hero-cycle-prefix hidden">a </span><span
              id="hero-cycle-word"
              data-words={JSON.stringify(heroWords)}
              class="hero-cycle-word"
            >
              Alfonso
            </span>
          </h1>
          <p class="max-w-2xl text-base text-ink/80">
            This is a place for the projects I’m working on, the ideas I’m exploring, and the things I’m learning along the way.
          </p>
          <div class="flex flex-wrap gap-4">
            <a
              class="inline-flex rounded-full border border-ink bg-ink px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-paper transition duration-300 hover:-translate-y-1 hover:border-ink/80 hover:bg-ink/90"
              href="/projects"
            >
              View projects
            </a>
            <a
              class="inline-flex rounded-full border border-ink/30 bg-paper/50 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-ink transition duration-300 hover:-translate-y-1 hover:border-ink/40 hover:bg-paper/70"
              href="/blog"
            >
              Read writing
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="grid gap-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">About</h2>
      </div>
      <div class="grid gap-6 md:grid-cols-12">
        <div class="md:col-span-4">
          <div class="relative aspect-[4/5] w-full max-w-none overflow-hidden rounded-2xl border border-ink/10 bg-white/60 shadow-sm md:max-w-[260px]">
            <img
              src={selfPortrait.src}
              alt="Portrait of Alfonso"
              class="absolute inset-0 h-full w-full object-cover object-center"
              loading="lazy"
              decoding="async"
            />
          </div>
        </div>
        <div class="md:col-span-8 md:justify-self-end">
          <div class="max-w-3xl">
            <h3 class="text-2xl font-semibold leading-tight text-ink">
              I’m Alfonso — a designer, developer, and builder.
            </h3>
            <div class="mt-4 space-y-4 text-base text-ink/70">
              <p>
              I’m interested in systems, thoughtful design, and the intersection of technology and creativity.
              </p>
              <p>
                Most of what I do involves exploring ideas, building projects, and sharing what I learn along the way.
              </p>
              <p>This site is where I keep track of that process.</p>
            </div>
            <div class="mt-6">
              <a
                class="inline-flex rounded-full border border-ink/20 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-ink transition hover:border-ink/30 hover:-translate-y-1"
                href="/blog"
              >
                Read writing
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid gap-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Projects</h2>
        <a class="text-sm text-ink/70 hover:text-spice" href="/projects">View all</a>
      </div>
      <div class="grid gap-6">
        {projects.map((project) => (
          <ProjectCard
            project={{
              title: project.data.title,
              description: project.data.description,
              category: project.data.category,
            }}
            imageSrc={sampleBg.src}
            href={`/projects/${project.slug}`}
          />
        ))}
      </div>
      <div class="flex justify-end">
        <a class="text-sm text-ink/70 hover:text-spice" href="/projects">View all projects</a>
      </div>
      <div aria-hidden="true" class="border-t border-ink/10"></div>
    </div>

    <div class="grid gap-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Latest posts</h2>
        <a class="text-sm text-ink/70 hover:text-spice" href="/blog">View all</a>
      </div>
      <div class="grid gap-6 md:grid-cols-3">
        {latest.map((post) => (
          <BlogCard post={post} />
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<script is:inline>
  (() => {
    const el = document.getElementById('hero-cycle-word');
    const prefixEl = document.getElementById('hero-cycle-prefix');
    if (!el || !prefixEl) return;

    const words = JSON.parse(el.getAttribute('data-words') || '[]');
    if (!Array.isArray(words) || words.length < 1) return;
    if (!words.every((word) => word && typeof word.label === 'string')) return;

    const variantClasses = [
      ...new Set(
        words
          .map((word) => (typeof word.variant === 'string' ? word.variant : ''))
          .filter(Boolean)
      ),
    ];

    const applyWord = (word) => {
      if (word.isName) {
        prefixEl.classList.add('hidden');
        el.textContent = 'Alfonso';
      } else {
        prefixEl.classList.remove('hidden');
        el.textContent = `${word.label}.`;
      }
      if (variantClasses.length) {
        el.classList.remove(...variantClasses);
        if (word.variant) el.classList.add(word.variant);
      }
    };

    let index = 0;
    const startDelayMs = 3000;
    const holdMs = 2400;
    const swapDelayMs = 260;
    const enterDurationMs = 520;

    const cycle = () => {
      el.classList.add('is-leaving');

      window.setTimeout(() => {
        index = (index + 1) % words.length;
        applyWord(words[index]);
        el.classList.remove('is-leaving');
        el.classList.add('is-entering');

        window.setTimeout(() => {
          el.classList.remove('is-entering');
        }, enterDurationMs);
      }, swapDelayMs);
    };

    window.setTimeout(() => {
      applyWord(words[index]);
      window.setInterval(cycle, holdMs);
    }, startDelayMs);
  })();
</script>

<style>
  .hero-cycle-word {
    font-weight: 600;
    letter-spacing: 0.08em;
    font-style: normal;
    opacity: 1;
    transform: translateY(0);
    filter: blur(0px);
    transition:
      opacity 320ms ease,
      transform 320ms ease,
      filter 320ms ease;
    will-change: opacity, transform, filter;
  }

  .hero-cycle-prefix {
    font-style: normal;
    letter-spacing: 0;
    font-weight: inherit;
  }

  .hero-word-designer {
    letter-spacing: 0.12em;
    font-weight: 600;
  }

  .hero-word-developer {
    letter-spacing: 0.05em;
    font-weight: 650;
  }

  .hero-word-builder {
    letter-spacing: 0.08em;
    font-weight: 560;
  }

  .hero-word-storyteller {
    letter-spacing: 0.1em;
    font-weight: 500;
    font-style: italic;
  }

  .hero-cycle-word.is-leaving {
    opacity: 0;
    transform: translateY(8px);
    filter: blur(3px);
  }

  .hero-cycle-word.is-entering {
    opacity: 0;
    transform: translateY(-8px);
    filter: blur(3px);
    animation: hero-word-enter 520ms cubic-bezier(0.33, 0, 0.2, 1) forwards;
  }

  @keyframes hero-word-enter {
    from {
      opacity: 0;
      transform: translateY(-8px);
      filter: blur(3px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0px);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .hero-cycle-word,
    .hero-cycle-word.is-leaving,
    .hero-cycle-word.is-entering {
      animation: none;
      transition: none;
      transform: none;
      filter: none;
    }
  }
</style>
